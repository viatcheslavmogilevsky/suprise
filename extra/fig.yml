# sudo fig run -d mq #
# sudo fig run -d redis
# sudo fig run -d db #

# sudo fig run --rm proxyDeploy
# sudo docker run \
#   --name="proxyRunner"
#   -p 8080:80 \
#   --volumes-from=railsapp_proxySetup_1 \
#   -w   /usr/local/openresty/nginx/sbin  \
#   -d  viatcheslavmogilevsky/openresty:1.7.2.1  \
#  ./nginx -c /edge/config/nginx.conf -g 'daemon off;'
# sudo docker logs -f proxyRunner
## edit some code
## sudo fig run --rm proxyDeploy
## sudo docker restart proxyRunner
# sudo fig run proxySaver
# sudo docker export railsapp_proxySaver_run_1 | sudo docker import - viatcheslavmogilevsky/gp_proxy:$(git log --pretty=format:'%h' -n 1)
# sudo docker rm railsapp_proxySaver_run_1
# sudo docker push viatcheslavmogilevsky/gp_proxy:$(git log --pretty=format:'%h' -n 1)
## sudo docker run \
##   -p 8181:80 \
##   -w /usr/local/openresty/nginx/sbin  \
##   -d viatcheslavmogilevsky/gp_proxy:$(git log --pretty=format:'%h' -n 1)  \
##   ./nginx -c /app/config/nginx.conf -g 'daemon off;'





# sudo fig run --rm gpAdminBundle

# sudo fig run --rm gpAdminRake db:create
# sudo fig run --rm gpAdminRake db:migrate
# sudo fig run --rm gpAdminRake db:seed

# sudo docker run \
#   --name="gpAdmin" \
#   -p 3000:3000 \
#   --volumes-from=goparcel_gpAdminSetup_1 \
#   -v $(pwd)/:/edge \
#   -v $(pwd)/database-for-docker.yml:/edge/config/database.yml \
#   -v $(pwd)/redis-for-docker.yml:/edge/config/redis.yml \
#   --link goparcel_db_1:db \
#   --link goparcel_redis_1:redis \
#   -w  /edge  \
#   -d  \
#   viatcheslavmogilevsky/gp_admin_base0.0.1-ruby2.1.2 \
#   /app_bin/rails s -p 3000

# tail -f log/development.log
## edit some code
## sudo fig run --rm gpAdminBundle
## sudo fig run --rm gpAdminRake db:create
## sudo fig run --rm gpAdminRake db:migrate
## sudo fig run --rm gpAdminRake db:seed

# # export GLOBAL_GITIGNORE_PATH=$(git config --global core.excludesfile || echo $(pwd)/.empty_gitignore)
##  sudo fig run gpAdminSaver
# # unset GLOBAL_GITIGNORE_PATH

# sudo docker run \
#   --name="gpAdminSaver" \
#   -v $(pwd)/:/edge \
#   -v $(pwd)/database-for-docker.yml:/database.yml \
#   -v $(pwd)/redis-for-docker.yml:/redis.yml \
#   -v $(git config --global core.excludesfile || echo $(pwd)/.empty_gitignore):/.gitignore_global \
#   viatcheslavmogilevsky/gp_admin:f354bb6 \
#   ansible-playbook  /edge/create-dockerized-admin.yml -c local

# sudo sh -c "docker export gpAdminSaver | docker import - viatcheslavmogilevsky/gp_admin:$(git log --pretty=format:'%h' -n 1)"
# sudo docker rm gpAdminSaver
# sudo docker run \
#    -p 3001:3000 \
#    -w /project  \
#    -d viatcheslavmogilevsky/gp_admin:$(git log --pretty=format:'%h' -n 1)  \
#    --link goparcel_db_1:db \
#    --link goparcel_redis_1:redis \
#    /app_bin/rails s -p 3000


mq:
  image: dockerfile/rabbitmq
  ports:
    - "5673:5672"
    - "15673:15672"
redis:
  image: redis:2.8
db:
  image: postgres:9.3

gpAdminSetup:
  image: viatcheslavmogilevsky/gp_admin_base0.0.1-ruby2.1.2
  volumes:
    - "/bundle"
    - "/app_bin"
    - "/gemfiles"

gpAdminBundle:
  image: viatcheslavmogilevsky/gp_admin_base0.0.1-ruby2.1.2
  volumes_from:
    - gpAdminSetup
  volumes:
    - ".:/edge"
    # - "./Gemfile:/Gemfile:ro"
    # - "./Gemfile.lock:/Gemfile.lock:ro"
    # - "./vendor/gems:/vendored-gems:ro" # special for Eduard
    # - "./bundle-dockerized-admin.yml:/bundle.yml:ro"
  command: "ansible-playbook  /edge/bundle-dockerized-admin.yml -c local"

gpAdminRake:
  image: viatcheslavmogilevsky/gp_admin_base0.0.1-ruby2.1.2
  volumes_from:
    - gpAdminSetup
  volumes:
    - ".:/edge"
    - "./database-for-docker.yml:/edge/config/database.yml" # VIOLATION of http://12factor.net/config
    - "./redis-for-docker.yml:/edge/config/redis.yml"       # VIOLATION of http://12factor.net/config
  working_dir: /edge
  entrypoint: /app_bin/rake
  links:
    - db
    - redis

gpAdminSaver:
  image: viatcheslavmogilevsky/gp_admin_base0.0.1-ruby2.1.2
  # volumes_from:
  #   - gpAdminSetup
  volumes:
    - $GLOBAL_GITIGNORE_PATH:/.gitignore_global
    - "/tmp"
    - ".:/edge"
    - "./database-for-docker.yml:/edge/config/database.yml" # VIOLATION of http://12factor.net/config
    - "./redis-for-docker.yml:/edge/config/redis.yml"       # VIOLATION of http://12factor.net/config
  command: "ansible-playbook  /edge/create-dockerized-admin.yml -c local"






  #command: "ls /app_bin"
  # ports:
  #   - "3000:3000"

# gpEngine:
#   image: viatcheslavmogilevsky/gpengine:XXX
#   ports:
#     - "8080:8080"



# proxySetup:
#   image: viatcheslavmogilevsky/openresty:1.7.2.1
#   volumes:
#     - "/edge"
# proxyDeploy:
#   image: viatcheslavmogilevsky/openresty:1.7.2.1
#   volumes_from:
#     - proxySetup
#   volumes:
#     - "./roles/openresty-application:/roles/openresty-application:ro"
#     - "./deploy-dockerized-proxy.yml:/deploy.yml:ro"
#   command: "ansible-playbook  --extra-vars='{\"app_path\":\"/edge\"}' /deploy.yml -c local"

# proxyRunner:
#   ports:
#     - "8080:80"
#   image: viatcheslavmogilevsky/openresty:1.7.2.1
#   volumes_from:
#     - proxySetup
#   working_dir: /usr/local/openresty/nginx/sbin
#   command: "./nginx -c /edge/config/nginx.conf -g 'daemon off;'"
# proxySaver:
#   image: viatcheslavmogilevsky/openresty:1.7.2.1
#   volumes:
#     - "./roles/openresty-application:/roles/openresty-application:ro"
#     - "./deploy-dockerized-proxy.yml:/deploy.yml:ro"
#   command: "ansible-playbook  --extra-vars='{\"app_path\":\"/app\"}' /deploy.yml -c local"





